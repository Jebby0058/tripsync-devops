<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSync | Travel & Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero-section { background: linear-gradient(135deg, #0d6efd, #0dcaf0); color: white; padding: 60px 0; text-align: center; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; margin-bottom: 40px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏¥‡∏¢‡∏≤‡∏¢ */
        #adminPanel { display: none; background: #ffeeba; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">‚úàÔ∏è TripSync</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('trips')">‡∏à‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('bookings')">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('blogs')">‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="userGreeting" class="text-white me-3"></span>
                    <button id="loginBtn" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="logoutBtn" class="btn btn-danger btn-sm d-none" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="display-4 fw-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà TripSync</h1>
        <p class="lead">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <div class="container mb-5">
        
        <div id="adminPanel" class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-dark">üëë Admin Tools:</span>
            <button class="btn btn-danger btn-sm" onclick="setupDatabase()">1. üõ†Ô∏è Setup Database</button>
        </div>

        <div id="trips" class="section-view active">
            <div class="d-flex justify-content-between mb-4">
                <h2>üåç ‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á</h2>
                <button id="addTripBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#addTripModal">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà (Admin)</button>
            </div>
            <div class="row" id="trip-list"></div>
        </div>

        <div id="bookings" class="section-view">
            <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="card p-3 mt-3">
                <table class="table table-hover table-striped">
                    <thead class="table-dark"><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏ó‡∏£‡∏¥‡∏õ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead>
                    <tbody id="booking-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="blogs" class="section-view">
            <div class="d-flex justify-content-between mb-4">
                <h2>üìù ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlogModal">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å</button>
            </div>
            <div class="row" id="blog-list"></div>
        </div>

    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h5></div>
                <div class="modal-body">
                    <input type="text" id="authUsername" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
                    <input type="password" id="authPassword" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                        <button class="btn btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTripModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <input type="text" id="tripTitle" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏¥‡∏õ">
                    <input type="number" id="tripPrice" class="form-control mb-2" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                    <input type="number" id="tripStock" class="form-control mb-2" placeholder="‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á">
                    <button class="btn btn-success w-100 mt-2" onclick="addTrip()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addBlogModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</h5></div>
                <div class="modal-body">
                    <input type="text" id="blogTitle" class="form-control mb-3" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏Å">
                    <textarea id="blogContent" class="form-control mb-3" rows="4" placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß..."></textarea>
                    <label class="form-label fw-bold">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏ß‡∏¢‡πÜ:</label>
                    <input type="file" id="blogImage" class="form-control mb-3" accept="image/*">
                    <button class="btn btn-primary w-100" onclick="addBlog()">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api';

        // =====================================
        // ‡∏£‡∏∞‡∏ö‡∏ö Login ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        // =====================================
        function checkAuth() {
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('role');
            
            if (username) {
                document.getElementById('userGreeting').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${username}`;
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('logoutBtn').classList.remove('d-none');
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏ö
                if (role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'flex';
                    document.getElementById('addTripBtn').classList.remove('d-none');
                }
            } else {
                document.getElementById('userGreeting').innerText = '';
                document.getElementById('loginBtn').classList.remove('d-none');
                document.getElementById('logoutBtn').classList.add('d-none');
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('addTripBtn').classList.add('d-none');
            }
        }

        async function login() {
            const u = document.getElementById('authUsername').value;
            const p = document.getElementById('authPassword').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('role', data.role);
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    checkAuth();
                    alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${data.username}`);
                } else alert(data.error);
            } catch(e) { console.error(e); }
        }

        async function register() {
            const u = document.getElementById('authUsername').value;
            const p = document.getElementById('authPassword').value;
            if(!u || !p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            try {
                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                alert(data.message || data.error);
            } catch(e) { console.error(e); }
        }

        function logout() {
            localStorage.clear();
            checkAuth();
            alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
        }

        // =====================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (Trips, Blogs, Setup)
        // =====================================
        function switchMenu(sectionId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'trips') loadTrips();
            if (sectionId === 'bookings') loadBookings();
            if (sectionId === 'blogs') loadBlogs();
        }

        async function setupDatabase() {
            const res = await fetch(`${API_URL}/setup-db`);
            const data = await res.json();
            alert('‚úÖ ' + data.message);
            loadTrips();
        }

        // ‡∏î‡∏∂‡∏á‡∏ó‡∏£‡∏¥‡∏õ
        async function loadTrips() {
            const res = await fetch(`${API_URL}/trips`);
            const trips = await res.json();
            document.getElementById('trip-list').innerHTML = trips.map(t => `
                <div class="col-md-4 mb-4">
                    <div class="card h-100 p-3">
                        <h5 class="card-title fw-bold text-primary">${t.title}</h5>
                        <h6 class="text-success mb-3">‡∏ø${t.price}</h6>
                        <p class="text-muted small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${t.stock} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</p>
                        <div class="input-group mt-auto">
                            <input type="text" id="user_${t.id}" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" value="${localStorage.getItem('username') || ''}">
                            <button class="btn btn-outline-primary" onclick="bookTrip(${t.id})">‡∏à‡∏≠‡∏á</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function addTrip() {
            await fetch(`${API_URL}/trips`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    title: document.getElementById('tripTitle').value, 
                    price: document.getElementById('tripPrice').value, 
                    stock: document.getElementById('tripStock').value 
                })
            });
            bootstrap.Modal.getInstance(document.getElementById('addTripModal')).hide();
            loadTrips();
        }

        async function bookTrip(trip_id) {
            const user_name = document.getElementById(`user_${trip_id}`).value;
            if(!user_name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
            const res = await fetch(`${API_URL}/bookings`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trip_id, user_name })
            });
            const data = await res.json(); alert(data.message);
        }

        async function loadBookings() {
            const res = await fetch(`${API_URL}/bookings`);
            const bookings = await res.json();
            document.getElementById('booking-table-body').innerHTML = bookings.map(b => `
                <tr><td>#${b.id}</td><td class="fw-bold">${b.user_name}</td><td>${b.trip_name}</td><td>${new Date(b.booking_date).toLocaleString('th-TH')}</td></tr>
            `).join('');
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å ---
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function addBlog() {
            const title = document.getElementById('blogTitle').value;
            const content = document.getElementById('blogContent').value;
            const fileInput = document.getElementById('blogImage').files[0];
            
            if (!title || !content) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            let imageBase64 = null;
            if (fileInput) {
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
                imageBase64 = await getBase64(fileInput);
            }

            await fetch(`${API_URL}/blogs`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content, image: imageBase64 })
            });
            
            bootstrap.Modal.getInstance(document.getElementById('addBlogModal')).hide();
            loadBlogs();
        }

        async function loadBlogs() {
            const res = await fetch(`${API_URL}/blogs`);
            const blogs = await res.json();
            document.getElementById('blog-list').innerHTML = blogs.map(b => `
                <div class="col-md-6 mb-4">
                    <div class="card p-0 h-100 overflow-hidden">
                        ${b.image ? `<img src="${b.image}" class="card-img-top" style="height: 200px; object-fit: cover;">` : ''}
                        <div class="p-4">
                            <h4 class="fw-bold mb-3">${b.title}</h4>
                            <p style="white-space: pre-line;">${b.content}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        checkAuth();
        loadTrips();
    </script>
</body>
</html>