<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSync | Travel & Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero-section { background: linear-gradient(135deg, #0d6efd, #0dcaf0); color: white; padding: 60px 0; text-align: center; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; margin-bottom: 40px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #adminPanel { display: none !important; background: #ffeeba; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">‚úàÔ∏è TripSync</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('trips')">‡∏à‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('bookings')">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchMenu('blogs')">‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="userGreeting" class="text-white me-3"></span>
                    <button id="loginBtn" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="logoutBtn" class="btn btn-danger btn-sm d-none" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="display-4 fw-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà TripSync</h1>
        <p class="lead">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏ô‡∏ù‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <div class="container mb-5">
        
        <div id="adminPanel" class="justify-content-between align-items-center">
            <span class="fw-bold text-dark">üëë Admin Tools:</span>
            <button class="btn btn-danger btn-sm" onclick="setupDatabase()">1. üõ†Ô∏è Setup Database</button>
        </div>

        <div id="trips" class="section-view active">
            <div class="d-flex justify-content-between mb-4">
                <h2>üåç ‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á</h2>
                <button id="addTripBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#addTripModal">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà (Admin)</button>
            </div>
            <div class="row" id="trip-list"></div>
        </div>

        <div id="bookings" class="section-view">
            <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="card p-3 mt-3">
                <table class="table table-hover table-striped">
                    <thead class="table-dark"><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏ó‡∏£‡∏¥‡∏õ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead>
                    <tbody id="booking-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="blogs" class="section-view">
            <div class="d-flex justify-content-between mb-4">
                <h2>üìù ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlogModal">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å</button>
            </div>
            <div class="row" id="blog-list"></div>
        </div>

    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="authUsername" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
                    <input type="password" id="authPassword" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
                    <button class="btn btn-primary w-100 mb-2" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button class="btn btn-outline-secondary w-100" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTripModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="newTripTitle" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏¥‡∏õ">
                    <input type="number" id="newTripPrice" class="form-control mb-3" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                    <input type="number" id="newTripStock" class="form-control mb-3" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á">
                    <button class="btn btn-success w-100" onclick="addTrip()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏£‡∏¥‡∏õ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api';

        function checkAuth() {
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('role');
            const adminPanel = document.getElementById('adminPanel');
            const addTripBtn = document.getElementById('addTripBtn');
            
            if (username) {
                document.getElementById('userGreeting').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${username}`;
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('logoutBtn').classList.remove('d-none');
                
                if (role === 'admin') {
                    adminPanel.style.setProperty('display', 'flex', 'important');
                    addTripBtn.classList.remove('d-none');
                } else {
                    adminPanel.style.setProperty('display', 'none', 'important');
                    addTripBtn.classList.add('d-none');
                }
            } else {
                document.getElementById('userGreeting').innerText = '';
                document.getElementById('loginBtn').classList.remove('d-none');
                document.getElementById('logoutBtn').classList.add('d-none');
                adminPanel.style.setProperty('display', 'none', 'important');
                addTripBtn.classList.add('d-none');
            }
        }

        async function login() {
            const u = document.getElementById('authUsername').value;
            const p = document.getElementById('authPassword').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('role', data.role);
                    location.reload(); 
                } else alert(data.error || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } catch(e) { console.error(e); }
        }

        async function register() {
            const u = document.getElementById('authUsername').value;
            const p = document.getElementById('authPassword').value;
            try {
                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                alert(data.message || data.error);
            } catch(e) { console.error(e); }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function switchMenu(sectionId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'trips') loadTrips();
            if (sectionId === 'bookings') loadBookings();
            // if (sectionId === 'blogs') loadBlogs(); // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô blog ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
        }

        async function setupDatabase() {
            try {
                const res = await fetch(`${API_URL}/setup-db`);
                const data = await res.json();
                alert('‚úÖ ' + data.message);
                loadTrips();
            } catch (e) {
                console.error(e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Setup Database');
            }
        }

        async function addTrip() {
            const title = document.getElementById('newTripTitle').value;
            const price = document.getElementById('newTripPrice').value;
            const stock = document.getElementById('newTripStock').value;
            
            try {
                const res = await fetch(`${API_URL}/trips`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title, price, stock })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('‚úÖ ' + data.message);
                    document.querySelector('#addTripModal .btn-close').click();
                    loadTrips();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (e) { console.error(e); }
        }

        async function loadTrips() {
            try {
                const res = await fetch(`${API_URL}/trips`);
                const trips = await res.json();
                document.getElementById('trip-list').innerHTML = trips.map(t => `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 p-3">
                            <h5 class="card-title fw-bold text-primary">${t.title}</h5>
                            <h6 class="text-success mb-3">‡∏ø${t.price}</h6>
                            <p class="text-muted small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${t.stock} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</p>
                            <div class="input-group mt-auto">
                                <input type="text" id="user_${t.id}" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" value="${localStorage.getItem('username') || ''}">
                                <button class="btn btn-outline-primary" onclick="bookTrip(${t.id})">‡∏à‡∏≠‡∏á</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch(e) { console.error("Error loading trips:", e); }
        }

        async function bookTrip(tripId) {
            const inputElement = document.getElementById(`user_${tripId}`);
            const userName = inputElement ? inputElement.value : '';
            
            if (!userName.trim()) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trip_id: tripId, user_name: userName })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert('‚úÖ ' + data.message);
                    loadBookings(); 
                } else {
                    alert('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                }
            } catch (e) {
                console.error(e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Database');
            }
        }

        async function loadBookings() {
            try {
                const res = await fetch(`${API_URL}/bookings`);
                const data = await res.json();
                const tbody = document.getElementById('booking-table-body');
                
                if (data.error) {
                    console.error("DB Error:", data.error);
                    return;
                }

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(b => `
                    <tr>
                        <td>${b.id}</td>
                        <td>${b.user_name}</td>
                        <td>${b.trip_name}</td>
                        <td>${new Date(b.booking_date).toLocaleString('th-TH')}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        checkAuth();
        loadTrips();
        loadBookings(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°
    </script>
</body>
</html>